<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chart per service approach</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/helm-tutorial/chart-per-service.html">
    <link rel="prev" href="create.html">
    <link rel="next" href="leader-chart.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/course-template"></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="helm-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Requirements</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html">Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Beginner</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basics.html">Basics and Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="create.html">Setup your first charts</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="chart-per-service.html">Chart per service approach</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="leader-chart.html">Leader Chart approach</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Helm Tutorial</a></li>
    <li>Beginner</li>
    <li><a href="chart-per-service.html">Chart per service approach</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/helm-tutorial/edit/master/documentation/modules/ROOT/pages/chart-per-service.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Chart per service approach</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Use a Helm chart per microservice approach if you seek to achieve flexible, simple versioning and low complexity charts to package your application.
Be careful, this technique might bring:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>huge amount of duplication</p>
</li>
<li>
<p>difficulty to keep consistent many templates</p>
</li>
<li>
<p>hardship to introduce global changes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Goal of this section: customize the configuration of the tutorial microservice with another template and deploy it using Helm charts in a different namespace/project.
</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_inject_configurations_from_a_configmap_template"><a class="anchor" href="#_inject_configurations_from_a_configmap_template"></a>Inject configurations from a configmap template</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When working with a microservice it is likely that you will inject and manage configurations using other Kubernetes resources, like
ConfigMap or Secret.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s inject a configuration from a ConfigMap for the tutorial microservice.
Navigate to the <code>templates</code> folder and create a <code>configmap.yaml</code>.
Open the <code>configmap.yaml</code> you just created and add the following:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.configmap.region | quote }}
  labels:
    {{- include "faq.labels" . | nindent 4 }}
data:
  region: {{.Values.configmap.region | upper | quote }} <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Change the value for region to uppercase.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now add the default value for a region in <code>values.yaml</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">configmap:
  key: region
  region: cee</code></pre>
</div>
</div>
<div class="paragraph">
<p>And configure the <code>deployment.yaml</code> template to use the new configmap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">          env:
            - name: POSTGRES_SERVER
              value: {{ .Values.postgresql.server | default (printf "%s-postgresql" ( .Release.Name )) | quote }}
            - name: POSTGRES_USERNAME
              value: {{ .Values.postgresql.postgresqlUsername | quote }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.secretName | default (printf "%s-postgresql" ( .Release.Name )) | quote }}
                  key: {{ .Values.postgresql.secretKey }}
            - name: REGION
              valueFrom:
                configMapKeyRef:
                  name: {{ .Values.configmap.region }}
                  key: {{ .Values.configmap.key }}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automatically_roll_out_deployments_when_a_configmapsecret_changes"><a class="anchor" href="#_automatically_roll_out_deployments_when_a_configmapsecret_changes"></a>Automatically roll out Deployments when a ConfigMap/Secret changes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configmaps and Secrets are often used as configuration files, but when values change in these files they are not automatically picked up by a running application unless the deployment spec itself changes.
This can potentially result in inconsistent deployments where the values have been updated but the application is actually still running with the old configuration wich is not what we want.</p>
</div>
<div class="paragraph">
<p>A solution to this problem is to use a <code>sha256sum</code> function which can be used to ensure a deployment&#8217;s annotation section is updated if another file changes:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Don&#8217;t change the deployment.yaml file. This next snippet is just an example.
</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Deployment
spec:
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can make this change even more elegant, because helm autogenerated the inclusion of annotations in <code>deployment.yaml</code> when we initialized our Chart:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above states the following: <strong>only</strong> if <code>.Values.podAnnotations</code> is defined, then get the yaml definition from there.</p>
</div>
<div class="paragraph">
<p>We can thus modify the <code>values.yaml</code> accordingly:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>podAnnotations</code> key might already be present in the <em>values.yaml</em>. Update it if it exists, or create a new entry if it&#8217;s missing.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">podAnnotations:
  checksum/config: '{{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the above value contains both YAML and a Go template, we need to parse the yaml (<code>toYaml</code>)
and use the template (<code>tpl</code>) in <code>deployment.yaml</code> with:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
      {{ tpl (toYaml .) $ | nindent 8 }}
      {{- end }}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upgrade_the_release"><a class="anchor" href="#_upgrade_the_release"></a>Upgrade the release</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Update the existing release with the newly added configurations:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm upgrade simple ./chart/faq</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the following commands to verify the CEE output:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export POD_NAME=$(oc get pods -l app.kubernetes.io/instance=simple -o jsonpath={.items[0]..metadata.name})
kubectl exec $POD_NAME -- /bin/curl -s localhost:8080/ask/CEE</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be a JSON Array that contains an Object with the region set to a capitalized version of <code>cee</code> from the <code>configmap</code> in <em>values.yaml</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_uninstall_a_release"><a class="anchor" href="#_uninstall_a_release"></a>Uninstall a release</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Simply run the following command to uninstall your previous releases:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm uninstall simple
helm uninstall faq-db</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_replicate_the_installation_in_a_different_namespace"><a class="anchor" href="#_replicate_the_installation_in_a_different_namespace"></a>Replicate the installation in a different namespace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s create a different namespace:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset1_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_minikube">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create ns qa

#permanently save the namespace for all subsequent kubectl commands
kubectl config set-context --current --namespace=qa</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_openshift">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create project qa</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And define a set of values for this namespace by making a copy of <code>values.yaml</code>. Name the copy <code>values.qa.yaml</code>.
Modify the region inside <code>values.qa.yaml</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">configmap:
  key: region
  region: benelux</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now install the charts:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset2_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_minikube">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install faq-db \
--set postgresqlUsername=faq-default,postgresqlPassword=postgres,postgresqlDatabase=faq,persistence.enabled=false,securityContext.enabled=false,containerSecurityContext.enabled=false \
bitnami/postgresql <i class="conum" data-value="1"></i><b>(1)</b>

helm install simple ./chart/faq --values ./chart/faq/values.qa.yaml <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_openshift">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install faq-db --set postgresqlUsername=faq-default,postgresqlPassword=postgres,postgresqlDatabase=faq,persistence.enabled=false,securityContext.enabled=false,containerSecurityContext.enabled=false,primary.podSecurityContext.enabled=false,primary.containerSecurityContext.enabled=
false --version 12.1.2 bitnami/postgresql <i class="conum" data-value="1"></i><b>(1)</b>

helm install simple ./chart/faq --values ./chart/faq/values.qa.yaml <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Install the PostgreSQL Helm chart in the new namespace/project.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Install the faq Helm chart in the <code>qa</code> namespace using the values dedicated to this namespace.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clean_up"><a class="anchor" href="#_clean_up"></a>Clean-Up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clean-Up the namespace to have it prepared for the following section:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm uninstall simple
helm uninstall faq-db</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="create.html">Setup your first charts</a></span>
  <span class="next"><a href="leader-chart.html">Leader Chart approach</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
